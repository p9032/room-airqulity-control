//control room airqulity
#include "DHT.h"  
#include <LiquidCrystal.h>
#include <DS3231.h>
#include <Wire.h>


//define input and output leg
#define DHT11PIN 2        //pin2  --D2
#define AQIPIN  21        //pin21 --A1
#define DEHUMIPIN  
#define POURERPIN
#define FANPIN   

//define variable
DHT dht;
float temperature ;
float humidity;
int dht_ok_or_not;
int aqi;

//key variables
LiquidCrystal lcd(8, 13, 9, 4, 5, 6, 7);
int adc_key_val[5] ={50, 200, 400, 600, 800 };
int NUM_KEYS = 5;
int adc_key_in;
int key=-1;
int oldkey=-1;

//clock variables
DS3231 Clock;
bool Century=false;
bool h12;
bool PM;
byte ADay, AHour, AMinute, ASecond, ABits;
bool ADy, A12h, Apm;
byte year, month, date, DoW, hour, minute, second;

//threshod
str menu [8] ={"vent","vent time","humi high","humi low","pour method","pour time","pour time","pour high","pour low"};
int threshod [8] ={0,0,80,60,0,0,200,100};		//80% on;60% off;aqi 200 on;aqi 100 off
int threshod_mode[8] ={0,0,1,1,0,0,2,2};		//0--bool;1--0to100;2--0to500
int menu_num=0;

//read DHT-11 , return temperature and Humidity
void dht_read()
{
	humidity=dht.getHumidity();
	temperature=dht.getTemperature();  
}

//show temp&humidity
void lcd_show()
{
    Serial.print("Humidity (%): ");
    Serial.println(humidity, 2);
    lcd.setCursor(0, 0);
    lcd.print("Humi (%): ");
    lcd.print(humidity);
    
    Serial.print("Temperature (oC): ");
    Serial.println(temperature, 2);
    lcd.setCursor(0, 1);
    lcd.print("Temp(oC): ");
    lcd.print(temperature);
    
	Serial.print("20");
	Serial.print(year,DEC);
	Serial.print('-');
	Serial.print(month,DEC);
	Serial.print('-');
	Serial.print(date,DEC);
	Serial.print(' ');
	Serial.print(hour,DEC);
	Serial.print(':');
	Serial.print(minute,DEC);
	Serial.print(':');
	Serial.print(second,DEC);
	Serial.print('\n');
}

//clock read
void ReadDS3231()
{
	int second,minute,hour,date,month,year,temperature; 
	second=Clock.getSecond();
	minute=Clock.getMinute();
	hour=Clock.getHour(h12, PM);
	date=Clock.getDate();
	month=Clock.getMonth(Century);
	year=Clock.getYear();
  
  
	Serial.print("20");
	Serial.print(year,DEC);
	Serial.print('-');
	Serial.print(month,DEC);
	Serial.print('-');
	Serial.print(date,DEC);
	Serial.print(' ');
	Serial.print(hour,DEC);
	Serial.print(':');
	Serial.print(minute,DEC);
	Serial.print(':');
	Serial.print(second,DEC);
	Serial.print('\n');

}

//menu & keyin
int key_press_or_not()
{
  adc_key_in = analogRead(0);    // read the value from the sensor 
  key = get_key(adc_key_in);  // convert into key press
  if (key != oldkey) return 1 else return 0   // if keypress is detected 
}

void key_menu()
{
    lcd.print("                ");  //clear the LCD
	key = get_key()；
	
	while (key != 5)
	{
		switch (key)
		{
			case 1:		//up
				if (menu_num==7) menu_num=0;
				menu_num=menu_num+1;
				menu_show();
				break;
			case 2: 	//down
				if (menu_num==0) menu_num=7;
				menu_num=menu_num-1;
				menu_show();
				break;
			case 3:		//left
				menu_set();
				menu_show();
				break;
			case 4:
				menu_set();
				menu_show();
				break;
			defaut:		//??
			
				break;	
			oldkey = key;
		}
	}

}

void menu_show()
{
	lcd.setCursor(0, 0);
	lcd.print(menu[menu_num]);
	lcd.setCursor(0, 1);
	lcd.print(threshod[menu_num]);
}


void menu_set()
{
	switch (threshod_mode[menu_num])	//choose menu data range
	{
	case 0:
		if (threshod[menu_num]==0)		threshod[menu_num]=1;
		if (threshod[menu_num]==1)		threshod[menu_num]=0;
		break;
	case 1:
		if (key==3)		
		{
			threshod[menu_num]++;
			if (threshod[menu_num] >=100)  threshod[menu_num]=0;			
		}
		if (key==4)		
		{
			threshod[menu_num]--;
			if (threshod[menu_num] <=0 or )  threshod[menu_num]=100;			
		}
		break;
	case 2:
		if (key==3)		
		{
			threshod[menu_num]++;
			if (threshod[menu_num] >=500)  threshod[menu_num]=0;			
		}
		if (key==4)		
		{
			threshod[menu_num]--;
			if (threshod[menu_num] <=0 or )  threshod[menu_num]=100;			
		}
		break;
	
	}
	threshod[menu_num]=   ;
}


// Convert ADC value to key number
int get_key()
{
    int k;
	delay(50);  // wait for debounce time
	adc_key_in = analogRead(0);    // read the value from the sensor
    for (k = 0; k < NUM_KEYS; k++)
    {
      if (input < adc_key_val[k])
      {
            return k;
        }
   }
   
    if (k >= NUM_KEYS)k = -1;  // No valid key pressed
    return k;
	
}

void pourer()
{
	if (menu[5]==0) 
	{
	//time control
	}
	else
	{
		if (aqi>threshod[7]) digitalWrite(POURERPIN,HIGH);
		if (aqi>threshod[8]) digitalWrite(POURERPIN,LOW);
	}

}

void Dehumidifier() 
{
	if (humidity>threshod[3]) digitalWrite(DEHUMIPIN,HIGH);
	if (humidity>threshod[4]) digitalWrite(DEHUMIPIN,LOW);
}

void fan() 
{
	//time control
}


void setup(){
	// 启动I2C(IIC)接口
	Wire.begin();
	//以下部分是初始化时间，每次板子通电之后都会初始化成这个时间，只是测试用，以后可以删除。
	Clock.setSecond(50);//Set the second 
	Clock.setMinute(59);//Set the minute 设置分钟
	Clock.setHour(11);  //Set the hour 设置小时
	Clock.setDoW(5);    //Set the day of the week 设置星期几
	Clock.setDate(31);  //Set the date of the month 设置月份
	Clock.setMonth(5);  //Set the month of the year 设置一年中的月份
	Clock.setYear(13);  //Set the year (Last two digits of the year) 设置年份(在今年的最后两位数——比如2013年最后的13)
	// Start the serial interface
	Serial.begin(9600);   //时间例子中是115200
  
	//初始化LCD
	lcd.clear(); 
	lcd.begin(16, 2);
	lcd.setCursor(0,0); 
   
	//初始化DHT11 
	pinMode (AQIPIN, INPUT);
	dht.setup(DHT11PIN); // data pin 2
    
	Serial.println("SETUP PARAMETER");
	Serial.println();

}

void loop()
{
	if (key_press_or_not())  key_menu() ;
	
	dht_read();
	ReadDS3231();
	lcd_show();
	pourer();
	Dehumidifier();
	fan();
	

	delay(2000);
}
